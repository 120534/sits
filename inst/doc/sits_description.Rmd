---
title: "SITS - An R Package for Data Analysis and Machine Learning using Satellite Image Time Series"
output: 
  pdf_document:
    citation_package: natbib
    fig_caption: yes
    keep_tex: yes
    template: latex-ms.tex
vignette: >
  %\VignetteIndexEntry{SITS - An R Package for Data Analysis and Machine Learning using Satellite Image Time Series}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::knitr}
author:
- name: Rolf Simoes
  affiliation: National Institute for Space Reseach (INPE), Brazil
- name: Gilberto Camara
  affiliation: National Institute for Space Reseach (INPE), Brazil
- name: Alexandre Carvalho
  affiliation: Institute for Applied Economics Research (IPEA), Brazil
- name: Victor Maus
  affiliation: International Institute for Applied System Analysis (IIASA), Switzerland
abstract: "Using time series derived from big Earth Observation data sets is one of the leading research trends in Land Use Science and Remote Sensing. One of the more promising uses of satellite time series is its application for classification of land use and land cover, since our growing demand for natural resources has caused major environmental impacts. The SITS package provides support on how to use statistical learning techniques with image time series. These methods include linear and quadratic discrimination analysis, support vector machines, random forests and neural networks."
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontfamily: mathdesign
fontfamilyoptions: adobe-utopia
fontsize: 11pt
bibliography: references-sits.bib
biblio-style: agsm
endnote: no
---
```{r, include = FALSE}
library(sits)
library(tibble)
```
# Introduction 
Earth observation satellites provide a continuous and consistent set of information about the Earthâ€™s land and oceans. Most space agencies have adopted an open data policy, making unprecedented amounts of satellite data available for research and operational use. This data deluge has brought about a major challenge: \textit{How to design and build technologies that allow the Earth observation community to analyse big data sets?}

The approach taken in the current package is to develop data analysis methods that work with satellite image time series (SITS). The time series are obtained by taking calibrated and comparable measures of the same location in Earth at different times. These measures can be obtained by a single sensor (e.g., MODIS) or by combining different sensors (e.g., LANDSAT-8 and SENTINEL-2). If obtained by frequent revisits, the temporal resolution of these data sets can capture the most important land use changes. 

Time series of remote sensing data show that land cover changes do not always occur in a progressive and gradual way, but they may also show periods of rapid and abrupt change followed either by a quick recovery [@Lambin2003]. Analyses of multiyear time series of land surface attributes, their fine-scale spatial pattern, and their seasonal evolution leads to a broader view of land-cover change. Satellite image time series have already been applied to applications such as mapping for detecting forest disturbance [@Kennedy2010], ecology dynamics [@Pasquarella2016], agricultural intensification [@Galford2008] and its impacts on deforestation [@Arvor2012].

The SITS package provides support on how to use statistical learning techniques with image time series. In a broad sense, statistical learning refers to a class of algorithms for classification and regression analysis [@Hastie2009]. These methods include linear and quadratic discrimination analysis, support vector machines, random forests and neural networks. In a typical classification problem, we have measures that capture class attributes. Based on these measures, referred as training data, one's task is to select a predictive model that allows inferring classes of a larger data set. 

Current approaches to image time series analysis still use limited number of attributes. A common approach is deriving a small set of phenological parameters from vegetation indexes, like beginning, peak, and length of growing season [@Brown2013] [@Kastens2017] [@Estel2015] [@Pelletier2016]. These phenological parameters are then fed in specialised classifiers such as TIMESAT [@Jonsson2004]. These approaches do not use the power of advanced statistical learning techniques to work on high-dimensional spaces and with big training data sets [@James2013].

The SITS package uses the full depth of satellite image time series to create larger dimensional spaces. We tested different methods of extracting attributes from time series data, including those reported by @Pelletier2016 and @Kastens2017. Our conclusion is that part of the information in raw time series is lost after filtering or statistical approximation. Thus, the method we developed has a deceptive simplicity: \emph{use all the data available in the time series samples}. The idea is to have as many temporal attributes as possible, increasing the dimension of the classification space. Our experiments found out that modern statistical models such as support vector machines, and random forests perform better in high-dimensional spaces than in lower dimensional ones. 
In what follows, we describe the main characteristics of the SITS package. The first part describes the basic data structures used in SITS and the tools used for visualisation and data exploration. Then we show how to do data acquisition from external sources, with an emphasis on the WTSS ("web time series service"). The next sections describe filtering and clustering techniques. We then discuss machine learning techniques for SITS data and how to apply them to image time series. Finally, we present validation methods.

# Data Handling and Visualisation Basics in SITS
The basic data unit in the sits package is the SITS tibble, which is a way of organizing a set of time series data with associated spatial information. In R, a "tibble" differs from the traditional data frame, insofar as a tibble can contain lists embedded as column arguments. Tibbles are part of the "tidyverse", a collection of R package designed to work together in data manipulation. The "tidyverse" includes packages such as "ggplot2", "dplyr" and "purrr" [@Wickham2017]. The "SITS" package makes extensive use of the "tidyverse". 

For a better explanation of how the "SITS tibble" works, we will read a data set containing  2,115 labelled samples of land cover in Mato Grosso state of Brazil. This state has 903,357 km\textsuperscript{2} of extension, being the third largest state of Brazil. It includes three of Brazil's biomes: Amazonia, Cerrado and Pantanal. It is the most important agricultural frontier of Brazil and is Brazil's largest producer of soybeans, corn and cotton. 

The samples contain time series extracted from the MODIS MOD13Q1 product from NASA from 2000 to 2016, provided every 16 days at 250-meter spatial resolution in the Sinusoidal projection. Based on ground surveys and high resolution imagery, we selected 2,115 samples of nine classes: forest, cerrado, pasture, soybean-fallow, fallow-cotton, soybean-cotton, soybean-corn, soybean-millet, and soybean-sunflower. Crop and pasture ground data was collected by researchers Alexandre Coutinho, Julio Esquerdo and Joao Antunes from the Brazilian Agricultural Research Agency (EMBRAPA) through farmer interviews in October 2009 and in October 2013. Samples for cerrado and forest classes were provided by Rodrigo Bergotti from INPE. Ground samples for soybean-fallow class were provided by Damien Arvor[@Arvor2012].

```{r}
# retrieve a set of samples from an RDS file
samples.tb <- readRDS(system.file("extdata/time_series/embrapa_mt.rds", 
                                  package = "sits"))
samples.tb
```

The "SITS tibble" contains data and metadata. The first six columns contain the metadata: spatial and temporal location, label assigned to the sample, and coverage from where the data has been extracted. The spatial location is given in longitude and latitude coordinates for the "WGS84" ellipsoid. For example, the first sample has been labelled "Pasture", at location (-55.1852, -10.8387), and is considered valid for the period (2013-09-14, 2014-08-29). Informing the dates where the label is valid is crucial for correct classification. In this case, the researchers involved in labelling the samples chose to use the agricultural calendar in Brazil, where the spring crop is planted in the months of September and October, and the autumn crop is planted in the months of February and March. For other applications and other countries, the relevant dates will most likely be different from those used in the example.

The SITS tibble also contains the time series data for each spatiotemporal location. The timeseries data is also organized as a tibble, with a column with the dates and the other columns with the values for each spectral band. 

```{r}
# print the first time series
samples.tb$time_series[[1]]
```

The SITS package provides functions for data manipulation and displaying information of a SITS tibble. For example, the function `sits_bands` lists the available bands.

```{r}
sits_bands(samples.tb)
```

Another useful command is `sits_labels` that shows the labels of the sample set and their frequencies.

```{r}
sits_labels(samples.tb)
```

In many cases, it is useful to relabel the data set. For examples, there may be situations when one wants to use a smaller set of labels, since samples in one label on the original set may not be distinguishable from samples with other labels. We then should use the `sits_relabel` function. This function requires a conversion list, as shown in the example below.

```{r}
# a list for relabelling the samples
new_labels <- list("Cerrado"       = "Savanna", 
                   "Pasture"       = "Grasslands", 
                   "Soy_Corn"      = "Double_Cropping",
                   "Soy_Cotton"    = "Double_Cropping",
                   "Soy_Sunflower" = "Double_Cropping",
                   "Soy_Fallow"    = "Single_Cropping",
                   "Soy_Millet"    = "Single_Cropping",
                   "Fallow_Cotton" = "Single_Cropping")
# apply the sits_relabel function
samples2.tb <- sits_relabel(samples.tb, new_labels)
# view the result
sits_labels(samples2.tb)
```

Given that we have used the tibble data format for the metadata and and the embedded time series, one can use the functions of the `dplyr`, `tidyr` and `purrr` packages of the "tidyverse" [@Wickham2017] to process the data. For example, the following code uses the `sits_select` function to get a subset of the sample data set with two bands ("ndvi" and "evi") and then uses the `dplyr::filter` function to select the samples labelled either as "Cerrado" or "Pasture". We can then use the `sits_plot` function to display the time series. Given a small number of samples to display, the `sits_plot` function tries to group as many spatial locations together. In the following example, the first 15 samples of the "Cerrado" class all refer to the same spatial location in consecutive time periods. For this reason, these samples are plotted together.

```{r fig.align="center", fig.height=3.1, fig.width=5}
# select the "ndvi" bands
samples_ndvi.tb <- sits_select(samples.tb, bands = c("ndvi"))
# select only the samples with the cerrado label
samples_cerrado.tb <- dplyr::filter(samples_ndvi.tb, label == "Cerrado")
# plot the first 15 samples (different dates for the same points)
sits_plot(samples_cerrado.tb[1:15,])
```

For a large number of samples, where the amount of individual plots would be substantial, the default visualisation combines all samples together in a single temporal interval (even if they are valid for different years). Therefore, all samples of the same band and the same label are aligned to a common interval. This plot is useful to show the spread of values for the time series of each band. The strong red line in the plot shows the median of the values, and the two orange lines are the first and third interquartile ranges. The `sits_plot` function has different ways of working. Please refer to the documentation for more details.

```{r, fig.align="center", fig.height=3.1, fig.width=5}
# plot all cerrado samples together (shows the distribution)
sits_plot(samples_cerrado.tb)
```

# Importing data into SITS
The SITS package allows different methods of data input, including: (a) obtain data from a WTSS (Web Series Time Service); (b) read data stored in a time series in the ZOO format [@Zeileis2005]; (c) read a time series from a RasterBrick [@Hijmans2015]. This section describes options (a) and (b). Option (c) will be described in the section were we describe raster processing. The WTSS service is a light-weight service, designed to retrieve time series for selected locations and periods [@Vinhas2016]. This service has been implemented by the research team of the National Institute for Space Research to allow remote access to time series data. To access the service, the user needs to provide a URL that points to the WTSS server location and use the function `sits_infoWTSS` that provides information on the coverages available on the server.

```{r}
URL <- "http://www.dpi.inpe.br/tws/wtss"
sits_infoWTSS(URL)
```

After finding out which coverages are available at the WTSS service, one may request specific information on each coverage by using the function `sits_coverageWTSS` which lists the contents of the data set, including source, bands, spatial extent and resolution, time range, and temporal resolution. This information is then stored in a tibble for later use.

```{r}
# get information about a specific coverage
coverage.tb <- sits_coverageWTSS(URL, "mod13q1_512")
coverage.tb
```

The user can then request one or more points using the `sits_getdata` function. This function provides a general means of access to image time series. In its simplest fashion, the user provides the latitude and longitude of the desired location, the URL of the WTSS service, the coverage name, the bands, and the start date and end date of the time series. If the start and end dates are not provided, all available period is retrived. The result is a SITS tibble that can be visualised using `sits_plot`.

```{r}
# a point in the transition forest pasture in Northern MT
long <- -55.57320
lat <- -11.50566
# obtain a time series from the WTSS server for this point
series.tb <- sits_getdata(longitude = long, latitude = lat, URL = URL, 
             coverage = "mod13q1_512", bands = c("ndvi", "evi"),
             start_date = "2001-01-01", end_date = "2016-12-31")
# plot the series
sits_plot(series.tb)
```

A useful case is when users have a set of labelled samples, that are to be used as a training data set. In this case, one usually has trusted observations which are labelled and commonly stored in plain text CSV format.


<!--
# References
\setlength{\parindent}{-0.2in}
\setlength{\leftskip}{0.2in}
\setlength{\parskip}{8pt}
\vspace*{-0.2in}
\noindent
-->
